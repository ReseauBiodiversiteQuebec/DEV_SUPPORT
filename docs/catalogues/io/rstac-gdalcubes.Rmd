---
title: "Example Rstac and gdalcubes scripts"
author: "Guillaume Larocque"
date: "`r Sys.Date()`"
output: html_document
eval: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## R Markdown

Load required Packages

```{r}
library(gdalcubes)
library(rstac)
```

Connect to STAC catalog

```{r}
s_obj <- stac("https://io.biodiversite-quebec.ca/stac/")
```


List collections
```{r}
collections <- s_obj |> collections() |> get_request()
```
Show collections and descriptions
```{r}
library(knitr)
df<-data.frame(id=character(),title=character(),description=character())
for (c in collections[['collections']]){
  df<-rbind(df,data.frame(id=c$id,title=c$title,description=c$description))
}
kable(df)
```

Search for a specific collection 
```{r}

it_obj <- s_obj |>
  stac_search(collections = "colombia-lc") |>
  post_request() |> items_fetch()
it_obj
```



```{r}
it_obj <- s_obj |>
  collections("colombia-lc") |> items() |>
  get_request() |> items_fetch()
it_obj
```


See item properties of first item
```{r}
it_obj[['features']][[1]]$properties
```
Summarize items
```{r}
df<-data.frame(id=character(),datetime=character(), description=character())
for (f in it_obj[['features']]){
  df<-rbind(df,data.frame(id=f$id,datetime=f$properties$datetime,description=f$properties$description))
}
kable(df)
```

Get one item and send it to STARS
```{r}
library(stars)
lc1<-read_stars(paste0('/vsicurl/',it_obj[['features']][[4]]$assets$data$href), proxy = TRUE)
plot(lc1)
```
Crop just a part of the raster
```{r}
bbox<-st_bbox(c(xmin = 928986, xmax = 1074396, ymax = 914365, ymin = 793894), crs = st_crs(3116))
lc1 |> st_crop(bbox)
```

Plot it
```{r}
plot(lc1)
```

Save as COG, using parameters appropriate for a categorical raster. 
```{r echo=FALSE}
lc1 |> st_crop(bbox) |> write_stars('/home/glaroc/lc1.tif',driver='COG',RasterIO=c('resampling'='mode'),options=c('COMPRESS=DEFLATE','OVERVIEW_RESAMPLING=MODE','LEVEL=6','OVERVIEW_COUNT=8','RESAMPLING=MODE','WARP_RESAMPLING=MODE','OVERVIEWS=IGNORE_EXISTING'))
```

This is a fix to add the data role to the assets. This is apparently needed for gdalcubes to work properly in newer versions
```{r}
for (i in 1:length(it_obj$features)){
  it_obj$features[[i]]$assets$data$roles='data'
}
```

Filter assets by properties and create collection
```{r echo=FALSE}
st <- stac_image_collection(it_obj$features, asset_names=c('data'), property_filter = function(f){f[['year']]=='2010-2012'},srs='EPSG:3116')
st
```



Build a cube for processing or viewing data. Note that this cube can be in a different CRS and resolution as the original items/files. However, the time dimension has to capture the time frame of the item. dt is expressed as a time period. P1D is a period of 1 day, P1M is a period of 1 month, P1Y is a period of one year. Resampling methods have to fit with the data type. For categorical data, use "mode" or "nearest". For continuous data, use "bilinear". Aggregation is only relevant when multiple rasters overlap. 
```{r}
v <- cube_view(srs = "EPSG:3116", extent = list(t0 = "2010-01-01", t1 = "2010-01-01",
                                                left = bbox$xmin, right =bbox$xmax, top = bbox$ymax, bottom = bbox$ymin),
               dx=30, dy=30, dt="P1D",
               aggregation = "first",
               resampling = "mode")
```

Match the collection and the cube view to build a raster cube. 
```{r}
lc_cube <- raster_cube(st, v)
```

```{r}
lc_cube |> write_tif('~/',prefix='lc2',creation_options=list('COMPRESS'='DEFLATE'))
```

```{r}
lc_cube |> plot(zlim=c(0,325000))
```
Use the Accessibility from cities dataset, but keep the same CRS and extent. Note that we need to adjust the times to match the one from the STAC item. 
```{r}
it_obj <- s_obj |>
  collections("accessibility_to_cities") |> items() |>
  get_request() |> items_fetch()
v <- cube_view(srs = "EPSG:3116", extent = list(t0 = "2015-01-01", t1 = "2015-01-01",
                                                left = bbox$xmin, right =bbox$xmax, top = bbox$ymax, bottom = bbox$ymin),
               dx=1000, dy=1000, dt="P1D",
               aggregation = "mean",
               resampling = "bilinear")
for (i in 1:length(it_obj$features)){
  it_obj$features[[i]]$assets$data$roles='data'
}
st <- stac_image_collection(it_obj$features)
lc_cube <- raster_cube(st, v)
lc_cube |> plot(col=heat.colors)
```


Use the CHELSA climatologies dataset, and create a map of the average for the months on June, July, August 2010 to 2020
```{r}
it_obj <- s_obj |>
  stac_search(collections = "chelsa-clim", datetime="2010-06-01T00:00:00Z/2020-08-01T00:00:00Z") |> post_request()

v <- cube_view(srs = "EPSG:3116", extent = list(t0 = "2015-01-01", t1 = "2015-12-31",
                                                left = bbox$xmin, right =bbox$xmax, top = bbox$ymax, bottom = bbox$ymin),
               dx=1000, dy=1000, dt="P1Y",
               aggregation = "mean",
               resampling = "bilinear")
for (i in 1:length(it_obj$features)){
  it_obj$features[[i]]$assets$data$roles='data'
}
st <- stac_image_collection(it_obj$features)
lc_cube <- raster_cube(st, v)
lc_cube |> plot(col=heat.colors)
```

